<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Go Budgeting - Pro Edition</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#09090b" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Go Budgeting">
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
            animation: { 
                'jelly': 'jelly 0.6s both',
                'fade-in': 'fadeIn 0.3s ease-out',
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: { 
                jelly: { 
                    '0%, 100%': { transform: 'scale(1)' }, 
                    '30%': { transform: 'scale(1.1, 0.9)' }, 
                    '50%': { transform: 'scale(0.9, 1.1)' }
                },
                fadeIn: {
                    'from': { opacity: 0, transform: 'translateY(10px)' },
                    'to': { opacity: 1, transform: 'translateY(0)' }
                }
            }
          }
        }
      }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0f0f0f;
            --bg-card: rgba(20, 20, 20, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border-color: rgba(255, 255, 255, 0.08);
            --border-light: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }
        
        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: rgba(248, 250, 252, 0.8);
            --bg-input: #f1f5f9;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: rgba(0, 0, 0, 0.08);
            --border-light: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --icon-bg: rgba(0, 0, 0, 0.05);
            --icon-color: #374151;
            --badge-bg: rgba(0, 0, 0, 0.05);
            --badge-text: #6b7280;
        }
        
        body { 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden;
            padding-bottom: 120px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Glass Header */
        .glass-header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .light-mode .glass-header {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid var(--border-light);
        }
        
        .glass-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
        }

        /* Jelly Card */
        .jelly-card { 
            background: var(--bg-card); 
            backdrop-filter: blur(15px); 
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 32px var(--shadow-color);
        }
        
        .light-mode .jelly-card {
            background: rgba(248, 250, 252, 0.9);
            border: 1px solid var(--border-light);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        .jelly-card:hover, .jelly-card:active {
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 12px 48px var(--shadow-color);
        }
        
        .light-mode .jelly-card:hover, .light-mode .jelly-card:active {
            border-color: rgba(0, 0, 0, 0.15);
        }

        /* History Box */
        .history-box {
            max-height: 380px;
            overflow-y: auto;
            scrollbar-width: none;
        }
        .history-box::-webkit-scrollbar { display: none; }

        /* Navbar */
        .nav-jelly { 
            background: rgba(15, 15, 15, 0.95); 
            backdrop-filter: blur(25px); 
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 -4px 32px var(--shadow-color),
                0 0 0 1px rgba(255, 255, 255, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 50;
        }
        
        .light-mode .nav-jelly {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.15);
            box-shadow: 
                0 -4px 32px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        /* Border glow effect untuk navbar */
        .nav-jelly::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, 
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.05) 30%,
                rgba(255, 255, 255, 0.08) 50%,
                rgba(255, 255, 255, 0.05) 70%,
                rgba(255, 255, 255, 0) 100%);
            border-radius: inherit;
            z-index: -1;
            pointer-events: none;
        }
        
        .light-mode .nav-jelly::before {
            background: linear-gradient(45deg, 
                rgba(0, 0, 0, 0) 0%,
                rgba(0, 0, 0, 0.03) 30%,
                rgba(0, 0, 0, 0.05) 50%,
                rgba(0, 0, 0, 0.03) 70%,
                rgba(0, 0, 0, 0) 100%);
        }
        
        /* Nav button styling */
        .nav-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 16px;
            padding: 12px;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .light-mode .nav-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .nav-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: scale(1.1);
        }
        
        .light-mode .nav-btn.active {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        /* Page View */
        .page-view { display: none; }
        .page-view.active { display: block; animation: fadeIn 0.4s ease; }
        
        /* Modal Base */
        .modal-base { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.95); 
            z-index: 100; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            backdrop-filter: blur(20px); 
        }
        
        .light-mode .modal-base {
            background: rgba(255, 255, 255, 0.98);
        }
        
        .modal-base.active { 
            display: flex; 
            animation: fadeIn 0.3s ease-out;
        }

        /* Loader Line */
        .loader-line {
            height: 3px;
            width: 100%;
            background: linear-gradient(to right, transparent, var(--text-primary), transparent);
            background-size: 200% 100%;
            animation: loading 1.5s infinite linear;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Install button highlight */
        #install-pwa-btn {
            position: relative;
            overflow: hidden;
        }
        
        #install-pwa-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Custom scrollbar untuk modal */
        .modal-scroll {
            max-height: 70vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        
        .modal-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-scroll::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }
        
        .modal-scroll::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        /* No scrollbar class */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Gradient border untuk modal */
        .gradient-border {
            position: relative;
            border: 1px solid transparent;
            background: linear-gradient(var(--bg-secondary), var(--bg-secondary)) padding-box,
                        linear-gradient(45deg, var(--border-color), rgba(255,255,255,0.05), var(--border-color)) border-box;
        }
        
        .light-mode .gradient-border {
            background: linear-gradient(var(--bg-secondary), var(--bg-secondary)) padding-box,
                        linear-gradient(45deg, var(--border-light), rgba(0,0,0,0.05), var(--border-light)) border-box;
        }
        
        /* Header buttons */
        .header-btn {
            background: rgba(24, 24, 27, 0.8);
            border-color: rgba(255, 255, 255, 0.05);
        }
        .header-btn:hover {
            background: rgba(39, 39, 42, 0.8);
        }
        .light-mode .header-btn {
            background: rgba(241, 245, 249, 0.9);
            border-color: rgba(0, 0, 0, 0.08);
        }
        .light-mode .header-btn:hover {
            background: rgba(226, 232, 240, 0.9);
        }
        
        /* Avatar light mode */
        .light-mode .light-mode-avatar {
            background: #e2e8f0;
        }
        
        /* Border light mode helper */
        .light-mode .light-mode-border {
            border-color: rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Badge items */
        .badge-item {
            color: #71717a;
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.05);
        }
        .light-mode .badge-item {
            color: #6b7280;
            background: rgba(0, 0, 0, 0.04);
            border-color: rgba(0, 0, 0, 0.08);
        }
        
        /* History container */
        .history-container {
            background: rgba(24, 24, 27, 0.4);
            border-color: rgba(255, 255, 255, 0.05);
        }
        .light-mode .history-container {
            background: rgba(241, 245, 249, 0.6);
            border-color: rgba(0, 0, 0, 0.08);
        }
        
        /* Nav plus border */
        .nav-plus-border {
            border-color: #000000;
        }
        .light-mode .nav-plus-border {
            border-color: #ffffff;
        }
        
        /* Modal content */
        .modal-content {
            background: #09090b;
            border-color: rgba(255, 255, 255, 0.1);
        }
        .light-mode .modal-content {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Modal close button */
        .modal-close-btn {
            background: #18181b;
            color: var(--text-primary);
        }
        .modal-close-btn:hover {
            background: #27272a;
        }
        .light-mode .modal-close-btn {
            background: #f1f5f9;
        }
        .light-mode .modal-close-btn:hover {
            background: #e2e8f0;
        }
        
        /* Modal select/input */
        .modal-select {
            background: #18181b;
            color: var(--text-primary);
        }
        .light-mode .modal-select {
            background: #f1f5f9;
            color: #1f2937;
        }
        
        /* Modal input bg */
        .modal-input-bg {
            background: rgba(24, 24, 27, 0.5);
        }
        .light-mode .modal-input-bg {
            background: rgba(241, 245, 249, 0.8);
        }
        
        /* Mode selector bg */
        .mode-selector-bg {
            background: #18181b;
        }
        .light-mode .mode-selector-bg {
            background: #f1f5f9;
        }
        
        /* Save button */
        .save-btn {
            background: #ffffff;
            color: #000000;
        }
        .save-btn:hover {
            background: #f4f4f5;
        }
        .light-mode .save-btn {
            background: #18181b;
            color: #ffffff;
        }
        .light-mode .save-btn:hover {
            background: #27272a;
        }
        
        /* Cancel button */
        .cancel-btn {
            background: #18181b;
            color: #ffffff;
            border-color: rgba(255, 255, 255, 0.05);
        }
        .cancel-btn:hover {
            background: #27272a;
        }
        .light-mode .cancel-btn {
            background: #f1f5f9;
            color: #1f2937;
            border-color: rgba(0, 0, 0, 0.08);
        }
        .light-mode .cancel-btn:hover {
            background: #e2e8f0;
        }
        
        /* Auth screen */
        .auth-screen {
            background: #000000;
        }
        .light-mode .auth-screen {
            background: #ffffff;
        }
        
        /* Install icon */
        .install-icon-bg {
            background: #ffffff;
        }
        .install-icon-color {
            color: #000000;
        }
        .light-mode .install-icon-bg {
            background: #18181b;
        }
        .light-mode .install-icon-color {
            color: #ffffff;
        }
        
        /* Icon picker button */
        .light-mode .icon-btn {
            background: #f1f5f9;
        }
        .light-mode .icon-btn:hover {
            background: #e2e8f0;
            border-color: rgba(0, 0, 0, 0.1);
        }
        .light-mode .icon-btn.border-white {
            border-color: #1f2937 !important;
        }
        .light-mode .icon-btn .text-white {
            color: #1f2937 !important;
        }
        
        /* Toast light mode */
        .light-mode #toast {
            background: #18181b;
            color: #ffffff;
        }
        
        /* Nav active text */
        .nav-active-text {
            color: #ffffff;
        }
        .light-mode .nav-active-text {
            color: #18181b;
        }
        
        /* Pocket icon background */
        .pocket-icon-bg {
            background: rgba(255, 255, 255, 0.05);
        }
        .pocket-icon-border {
            border-color: rgba(255, 255, 255, 0.05);
        }
        .light-mode .pocket-icon-bg {
            background: rgba(0, 0, 0, 0.05);
        }
        .light-mode .pocket-icon-border {
            border-color: rgba(0, 0, 0, 0.08);
        }
        
        /* History icon background */
        .history-icon-bg {
            background: #18181b;
        }
        .light-mode .history-icon-bg {
            background: #f1f5f9;
        }
        
        /* Progress track */
        .progress-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .light-mode .progress-track {
            background: rgba(0, 0, 0, 0.08);
        }
        
        /* Theme Toggle */
        .theme-toggle {
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: rotate(30deg);
        }
        
        /* Input khusus numeric */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Style untuk input dengan keyboard angka */
        .numeric-input {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
    </style>
</head>
<body class="font-sans">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-12 left-1/2 -translate-x-1/2 z-[200] px-6 py-3 rounded-2xl bg-white text-black font-bold text-[10px] opacity-0 transition-all shadow-2xl pointer-events-none uppercase tracking-widest backdrop-blur-sm"></div>

    <!-- MODAL INSTALL PWA -->
    <div id="modal-install" class="modal-base">
        <div class="modal-content w-full max-w-md p-8 rounded-[3rem] border space-y-6 gradient-border">
            <div class="flex justify-between items-center">
                <h4 class="text-xl font-black italic uppercase" style="color: var(--text-primary)">Pasang Go Budgeting</h4>
                <button onclick="closeModal('modal-install')" class="p-3 modal-close-btn rounded-2xl transition-colors">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="text-center space-y-4">
                <div class="w-20 h-20 install-icon-bg rounded-3xl flex items-center justify-center mx-auto shadow-lg">
                    <i data-lucide="download" class="w-10 h-10 install-icon-color"></i>
                </div>
                <div>
                    <p class="font-bold text-lg" style="color: var(--text-primary)">Pasang Aplikasi</p>
                    <p class="text-sm mt-2" style="color: var(--text-secondary)">Install Go Budgeting untuk akses lebih cepat, bekerja offline, dan notifikasi transaksi.</p>
                </div>
            </div>
            
            <div class="space-y-3 pt-4">
                <button onclick="installPWA()" id="install-button" class="w-full save-btn font-black py-5 rounded-2xl text-[11px] uppercase tracking-widest active:scale-95 transition-transform">
                    Install Sekarang
                </button>
                <button onclick="closeModal('modal-install')" class="w-full cancel-btn font-bold py-5 rounded-2xl text-[11px] uppercase tracking-widest border transition-colors">
                    Nanti Saja
                </button>
            </div>
            
            <div class="pt-4 border-t" style="border-color: var(--border-color)">
                <p class="text-[8px] text-center uppercase tracking-widest" style="color: var(--text-muted)">Aplikasi ini tidak memerlukan penyimpanan besar</p>
            </div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="screen-auth" class="fixed inset-0 z-[150] auth-screen flex items-center justify-center p-8">
        <div class="w-full max-w-sm space-y-8">
            <div class="text-center">
                <div class="w-20 h-20 install-icon-bg rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl">
                    <i data-lucide="shield-check" class="w-10 h-10 install-icon-color"></i>
                </div>
                <h1 class="text-4xl font-black tracking-tighter italic uppercase" style="color: var(--text-primary)">GO BUDGETING</h1>
                <p class="text-sm mt-2" style="color: var(--text-muted)">Edisi Pro</p>
            </div>
            <div class="space-y-3">
                <input type="email" id="auth-email" class="w-full p-5 rounded-2xl outline-none modal-select border border-white/5 light-mode-border transition-colors" style="color: var(--text-primary)" placeholder="Email">
                <input type="password" id="auth-password" class="w-full p-5 rounded-2xl outline-none modal-select border border-white/5 light-mode-border transition-colors" style="color: var(--text-primary)" placeholder="Kata Sandi">
                <button onclick="handleLogin()" class="w-full save-btn font-black py-5 rounded-2xl text-[11px] uppercase tracking-widest active:scale-95 transition-all">
                    Masuk Sistem
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="screen-app" class="hidden min-h-screen pb-24">
        <header class="p-6 sticky top-0 z-40 glass-header">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-zinc-800 light-mode-avatar rounded-full flex items-center justify-center border border-white/10 light-mode-border shadow-inner">
                        <i data-lucide="user" class="w-5 h-5 text-zinc-400"></i>
                    </div>
                    <div>
                        <p id="greeting" class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Halo...</p>
                        <p id="user-display" class="text-xs font-bold truncate w-32 md:w-auto" style="color: var(--text-primary)">Pengguna</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleTheme()" class="p-3 header-btn rounded-xl border shadow-inner active:scale-90 transition-transform theme-toggle">
                        <i id="theme-icon" data-lucide="sun" class="w-4 h-4 text-yellow-500"></i>
                    </button>
                    <button onclick="logout()" class="p-3 header-btn rounded-xl border shadow-inner active:scale-90 transition-transform">
                        <i data-lucide="log-out" class="w-4 h-4 text-rose-500"></i>
                    </button>
                </div>
            </div>
            <div>
                <p class="text-[9px] font-black uppercase tracking-[0.2em] mb-1" style="color: var(--text-muted)">Likuiditas Global (Total Aset)</p>
                <h2 id="total-balance" class="text-4xl font-black tracking-tighter" style="color: var(--text-primary)">Rp 0</h2>
            </div>
        </header>

        <main class="pb-8">
            <!-- VIEW: HOME -->
            <div id="view-home" class="page-view active p-6 space-y-8">
                <section>
                    <div class="flex justify-between items-center mb-4 px-1">
                        <h3 class="text-[10px] font-black text-zinc-500 uppercase tracking-[0.3em]">Ringkasan Brankas</h3>
                        <span id="pocket-count" class="text-[8px] font-black px-2 py-1 rounded-lg border badge-item">
                            0 Aktif
                        </span>
                    </div>
                    <div id="home-pockets-scroll" class="flex gap-4 overflow-x-auto pb-4 no-scrollbar snap-x">
                        <!-- Content akan diisi oleh JavaScript -->
                    </div>
                </section>
                
                <section>
                    <div class="flex justify-between items-center mb-4 px-1">
                        <h3 class="text-[10px] font-black text-zinc-500 uppercase tracking-[0.3em]">Arus Kas Terkini</h3>
                        <span class="text-[8px] font-black px-2 py-1 rounded-lg border badge-item">
                            Real-time
                        </span>
                    </div>
                    <div class="history-container rounded-[2.5rem] border overflow-hidden shadow-2xl">
                        <div id="home-history" class="history-box p-2">
                            <!-- Content akan diisi oleh JavaScript -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- VIEW: POCKETS -->
            <div id="view-pockets" class="page-view p-6">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h3 class="text-2xl font-black tracking-tight italic" style="color: var(--text-primary)">Brankas Pocket</h3>
                        <p class="text-[10px] mt-1" style="color: var(--text-muted)">Kelola semua brankas keuangan Anda</p>
                    </div>
                    <button onclick="openPocketModal()" class="w-12 h-12 bg-white text-black rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition-transform hover:shadow-xl">
                        <i data-lucide="plus"></i>
                    </button>
                </div>
                <div id="pockets-grid" class="grid grid-cols-2 gap-4 pb-10">
                    <!-- Content akan diisi oleh JavaScript -->
                </div>
                <div id="loader-pockets" class="hidden py-4 text-center">
                    <div class="loader-line mx-auto w-1/2"></div>
                </div>
            </div>

            <!-- VIEW: HISTORY -->
            <div id="view-history" class="page-view p-6">
                <div class="mb-8">
                    <h3 class="text-2xl font-black tracking-tight italic" style="color: var(--text-primary)">Data Arsip</h3>
                    <p class="text-[10px] mt-1" style="color: var(--text-muted)">Riwayat transaksi lengkap</p>
                </div>
                <div id="full-history" class="space-y-2 pb-10">
                    <!-- Content akan diisi oleh JavaScript -->
                </div>
                <div id="loader-history" class="hidden py-4 text-center">
                    <div class="loader-line mx-auto w-1/2"></div>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="page-view p-6 space-y-6">
                <div class="mb-8">
                    <h3 class="text-2xl font-black tracking-tight italic" style="color: var(--text-primary)">Keamanan & Aplikasi</h3>
                    <p class="text-[10px] mt-1" style="color: var(--text-muted)">Pengaturan sistem dan PWA</p>
                </div>
                <div class="space-y-3">
                    <!-- Tombol Install PWA -->
                    <button onclick="showInstallPrompt()" id="install-pwa-btn" class="jelly-card w-full p-6 rounded-[2.5rem] flex items-center gap-5 hidden animate-pulse-slow">
                        <div class="w-12 h-12 bg-blue-500/10 rounded-2xl flex items-center justify-center text-blue-500 border border-blue-500/20">
                            <i data-lucide="download"></i>
                        </div>
                        <div class="text-left flex-1">
                            <p class="font-bold text-sm" style="color: var(--text-primary)">Pasang Aplikasi</p>
                            <p class="text-[8px] font-bold uppercase" style="color: var(--text-muted)">Install PWA ke Perangkat</p>
                        </div>
                        <div class="text-right">
                            <span class="text-[8px] bg-blue-500/10 text-blue-500 px-2 py-1 rounded-lg border border-blue-500/20 font-black">
                                BARU
                            </span>
                        </div>
                    </button>
                    
                    <button onclick="downloadCSV()" class="jelly-card w-full p-6 rounded-[2.5rem] flex items-center gap-5 hover:border-emerald-500/20">
                        <div class="w-12 h-12 bg-emerald-500/10 rounded-2xl flex items-center justify-center text-emerald-500 border border-emerald-500/20">
                            <i data-lucide="download"></i>
                        </div>
                        <div class="text-left">
                            <p class="font-bold text-sm" style="color: var(--text-primary)">Ekspor Laporan</p>
                            <p class="text-[8px] font-bold uppercase" style="color: var(--text-muted)">Unduh CSV</p>
                        </div>
                    </button>
                    
                    <button onclick="resetAllData()" class="jelly-card w-full p-6 rounded-[2.5rem] border border-rose-500/20 flex items-center gap-5 hover:border-rose-500/30">
                        <div class="w-12 h-12 bg-rose-500/10 rounded-2xl flex items-center justify-center text-rose-500 border border-rose-500/20">
                            <i data-lucide="trash-2"></i>
                        </div>
                        <div class="text-left">
                            <p class="font-bold text-sm text-rose-500">Hapus Database</p>
                            <p class="text-[8px] font-bold uppercase" style="color: var(--text-muted)">Hapus Semua Data</p>
                        </div>
                    </button>
                    
                    <!-- Info PWA Status -->
                    <div id="pwa-status" class="jelly-card p-4 rounded-2xl border mt-4" style="border-color: var(--border-color)">
                        <p class="text-[9px] font-black uppercase mb-1" style="color: var(--text-muted)">Status Aplikasi</p>
                        <div class="flex items-center justify-between">
                            <p class="text-xs" style="color: var(--text-primary)">Mode: <span id="app-mode">Browser</span></p>
                            <span id="pwa-badge" class="text-[8px] bg-zinc-800 text-zinc-400 px-2 py-1 rounded-lg border border-white/5 font-black">
                                PWA Siap
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- NAVIGATION -->
        <nav class="nav-jelly fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-md h-20 rounded-[2.5rem] flex items-center justify-around px-2 z-50 shadow-2xl">
            <button onclick="nav('view-home', this)" class="nav-btn p-4 active nav-active-text">
                <i data-lucide="home" class="w-5 h-5"></i>
            </button>
            
            <button onclick="nav('view-pockets', this)" class="nav-btn p-4 text-zinc-400">
                <i data-lucide="wallet" class="w-5 h-5"></i>
            </button>
            
            <div class="relative -top-4">
                <button onclick="openUnifiedModal()" class="w-16 h-16 bg-gradient-to-br from-white to-zinc-200 text-black rounded-3xl flex items-center justify-center shadow-2xl active:scale-90 transition-transform hover:shadow-3xl hover:scale-105 group">
                    <i data-lucide="plus" class="w-8 h-8 group-hover:rotate-90 transition-transform"></i>
                </button>
                <div class="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center border-2 nav-plus-border">
                    <span class="text-[8px] font-black text-white">+</span>
                </div>
            </div>
            
            <button onclick="nav('view-history', this)" class="nav-btn p-4 text-zinc-400">
                <i data-lucide="history" class="w-5 h-5"></i>
            </button>
            
            <button onclick="nav('view-settings', this)" class="nav-btn p-4 text-zinc-400">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </nav>
    </div>

    <!-- MODAL TRANSAKSI (CREATE/EDIT) -->
    <div id="modal-unified" class="modal-base">
        <div class="modal-content w-full max-w-md p-8 rounded-[3rem] border space-y-6 gradient-border">
            <div class="flex justify-between items-center">
                <h4 id="tx-title" class="text-xl font-black italic uppercase" style="color: var(--text-primary)">Catatan Arus</h4>
                <button onclick="closeModal('modal-unified')" class="p-3 modal-close-btn rounded-2xl transition-colors">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="tx-mode-selector" class="flex p-1 mode-selector-bg rounded-2xl border border-white/5 light-mode-border">
                <button onclick="setMode('expense', this)" class="mode-btn flex-1 py-4 rounded-xl text-[10px] font-black uppercase bg-white text-black">Keluar</button>
                <button onclick="setMode('income', this)" class="mode-btn flex-1 py-4 rounded-xl text-[10px] font-black uppercase text-zinc-400">Masuk</button>
                <button onclick="setMode('transfer', this)" class="mode-btn flex-1 py-4 rounded-xl text-[10px] font-black uppercase text-zinc-400">Transfer</button>
            </div>

            <div class="space-y-4">
                <div class="modal-input-bg rounded-2xl p-6 border border-white/5 light-mode-border">
                    <p class="text-[9px] font-bold uppercase mb-2" style="color: var(--text-muted)">Nominal (Rp)</p>
                    <div class="flex items-center gap-2">
                        <span class="text-xl font-bold" style="color: var(--text-muted)">Rp</span>
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="u-amount" 
                               class="w-full bg-transparent text-4xl font-black outline-none border-none p-0 focus:ring-0 placeholder:text-zinc-700 numeric-input" 
                               style="color: var(--text-primary)"
                               placeholder="0" 
                               oninput="formatNumberInput(this)">
                    </div>
                </div>

                <div id="ui-standard" class="space-y-3">
                    <select id="u-pocket" class="w-full p-5 rounded-2xl outline-none modal-select border border-white/5 light-mode-border text-sm transition-colors">
                        <option value="">Pilih Brankas</option>
                    </select>
                </div>

                <div id="ui-transfer" class="hidden grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <p class="text-[8px] font-bold uppercase ml-2" style="color: var(--text-muted)">Dari</p>
                        <select id="u-tf-from" class="w-full p-4 rounded-2xl outline-none modal-select border border-white/5 light-mode-border text-xs transition-colors">
                            <option value="">Pilih Brankas</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <p class="text-[8px] font-bold uppercase ml-2" style="color: var(--text-muted)">Ke</p>
                        <select id="u-tf-to" class="w-full p-4 rounded-2xl outline-none modal-select border border-white/5 light-mode-border text-xs transition-colors">
                            <option value="">Pilih Brankas</option>
                        </select>
                    </div>
                </div>

                <input type="text" id="u-note" class="w-full p-5 rounded-2xl outline-none modal-select border border-white/5 light-mode-border text-sm transition-colors" style="color: var(--text-primary)" placeholder="Catatan (opsional)">

                <div class="flex gap-2 pt-2">
                    <button id="btn-del-tx" onclick="deleteTransaction()" class="hidden flex-1 bg-rose-500/10 text-rose-500 font-bold py-5 rounded-2xl text-[10px] uppercase border border-rose-500/20 active:scale-95 transition-transform hover:bg-rose-500/20">
                        Hapus
                    </button>
                    <button onclick="saveUnified()" class="flex-[2] save-btn font-black py-5 rounded-2xl text-[11px] uppercase tracking-widest active:scale-95 transition-transform">
                        Konfirmasi Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL POCKET -->
    <div id="modal-pocket" class="modal-base">
        <div class="modal-content w-full max-w-md p-8 rounded-[3rem] border space-y-6 gradient-border modal-scroll">
            <div class="flex justify-between items-center">
                <h4 id="pocket-title" class="text-xl font-black uppercase italic" style="color: var(--text-primary)">Setup Brankas</h4>
                <button onclick="closeModal('modal-pocket')" class="p-3 modal-close-btn rounded-2xl transition-colors">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div>
                <p class="text-[9px] font-bold uppercase mb-3" style="color: var(--text-muted)">Pilih Ikon</p>
                <div id="pocket-icons" class="grid grid-cols-5 gap-2 pb-2">
                    <!-- Icons akan diisi oleh JavaScript -->
                </div>
            </div>
            
            <div class="space-y-4">
                <div class="space-y-1">
                    <p class="text-[8px] font-bold uppercase ml-2" style="color: var(--text-muted)">Nama Brankas</p>
                    <input type="text" id="p-name" class="w-full p-5 rounded-2xl outline-none modal-select border border-white/5 light-mode-border text-sm transition-colors" style="color: var(--text-primary)" placeholder="Contoh: Dompet Digital">
                </div>
                
                <div class="space-y-1">
                    <p class="text-[8px] font-bold uppercase ml-2" style="color: var(--text-muted)">Saldo Sekarang (Rp)</p>
                    <input type="tel" inputmode="numeric" pattern="[0-9]*" id="p-balance" 
                           class="w-full p-5 rounded-2xl outline-none modal-select border border-white/5 light-mode-border text-sm transition-colors numeric-input" 
                           style="color: var(--text-primary)"
                           placeholder="0"
                           oninput="formatNumberInput(this)">
                </div>
                
                <div class="space-y-1">
                    <p class="text-[8px] font-bold uppercase ml-2" style="color: var(--text-muted)">Target Nabung (Rp)</p>
                    <input type="tel" inputmode="numeric" pattern="[0-9]*" id="p-target" 
                           class="w-full p-5 rounded-2xl outline-none modal-select border border-white/5 light-mode-border text-sm transition-colors numeric-input" 
                           style="color: var(--text-primary)"
                           placeholder="0 (opsional)"
                           oninput="formatNumberInput(this)">
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button id="btn-del-p" onclick="deletePocket()" class="hidden flex-1 bg-rose-500/10 text-rose-500 font-bold py-5 rounded-2xl text-[10px] uppercase border border-rose-500/20 active:scale-95 transition-transform hover:bg-rose-500/20">
                        Hapus
                    </button>
                    <button onclick="savePocket()" class="flex-[2] save-btn font-black py-5 rounded-2xl text-[11px] uppercase tracking-widest active:scale-95 transition-transform">
                        Simpan Brankas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://efslseqhmdaetljrsqyc.supabase.co"; 
        const SB_KEY = "sb_publishable_lRGGIEpyg_ZTA8CfEIIgaQ_yBJxjJ78"; 
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let user = null;
        let pockets = [];
        let currentMode = 'expense';
        let editingPocketId = null;
        let editingTxId = null;
        let selectedIcon = 'wallet';
        const ICONS = ['wallet', 'piggy-bank', 'briefcase', 'shopping-bag', 'home', 'car', 'heart', 'star', 'zap', 'coffee', 'credit-card', 'banknote', 'gem', 'trophy', 'gift', 'plane', 'shopping-cart', 'utensils', 'film', 'music'];

        // === PWA INSTALL FEATURE ===
        let deferredPrompt;
        const installBtn = document.getElementById('install-pwa-btn');
        const modalInstall = document.getElementById('modal-install');
        const appModeElement = document.getElementById('app-mode');
        const pwaBadgeElement = document.getElementById('pwa-badge');

        // Fungsi untuk memformat input angka
        function formatNumberInput(input) {
            // Hapus semua karakter non-digit
            let value = input.value.replace(/\D/g, '');
            
            // Format dengan titik pemisah ribuan
            if (value.length > 3) {
                value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
            
            input.value = value;
        }

        // Fungsi untuk mengubah string angka yang diformat menjadi number
        function parseFormattedNumber(formattedString) {
            if (!formattedString) return 0;
            return parseInt(formattedString.replace(/\./g, '')) || 0;
        }

        // Fungsi untuk toggle tema light/dark
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            
            if (html.classList.contains('dark')) {
                // Switch to light mode
                html.classList.remove('dark');
                html.classList.add('light-mode');
                themeIcon.setAttribute('data-lucide', 'moon');
                localStorage.setItem('theme', 'light');
            } else {
                // Switch to dark mode
                html.classList.remove('light-mode');
                html.classList.add('dark');
                themeIcon.setAttribute('data-lucide', 'sun');
                localStorage.setItem('theme', 'dark');
            }
            
            lucide.createIcons();
            
            // Re-render content & update nav buttons for new theme
            initializeNavButtons();
            if (pockets.length > 0 || document.getElementById('home-pockets-scroll').innerHTML) {
                renderHome();
                renderManage();
                loadHistory();
            }
            
            toast("Tema diubah");
        }

        // Fungsi untuk memuat tema dari localStorage
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme === 'light') {
                html.classList.remove('dark');
                html.classList.add('light-mode');
                themeIcon.setAttribute('data-lucide', 'moon');
            } else {
                html.classList.remove('light-mode');
                html.classList.add('dark');
                themeIcon.setAttribute('data-lucide', 'sun');
            }
        }

        async function init() {
            // Load theme first
            loadTheme();
            
            updateGreeting();
            updatePWAStatus();
            
            const { data } = await sb.auth.getSession();
            if (data.session) { 
                user = data.session.user; 
                showApp(); 
            } else {
                // Auto-focus email field on auth screen
                document.getElementById('auth-email').focus();
            }
            
            renderIconPicker();
            setupInfiniteScroll();
            lucide.createIcons();
            setInterval(updateGreeting, 60000);
            
            // Check PWA capabilities
            checkPWAFeatures();
            
            // Register Service Worker
            registerServiceWorker();
            
            // Initialize nav buttons
            initializeNavButtons();
            
            // Add input event listeners for numeric inputs
            setupNumericInputs();
        }

        // Setup numeric inputs
        function setupNumericInputs() {
            const numericInputs = document.querySelectorAll('.numeric-input');
            numericInputs.forEach(input => {
                input.addEventListener('focus', function() {
                    // Show numeric keyboard on mobile
                    if ('virtualKeyboard' in navigator) {
                        navigator.virtualKeyboard.show();
                    }
                });
            });
        }

        // Initialize navigation buttons
        function initializeNavButtons() {
            const isLight = document.documentElement.classList.contains('light-mode');
            const activeColor = isLight ? 'text-zinc-900' : 'text-white';
            
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                // Fix initial active button color
                if (btn.classList.contains('active')) {
                    btn.classList.remove('text-white', 'text-zinc-900');
                    btn.classList.add(activeColor);
                }
                
                btn.addEventListener('click', function() {
                    navButtons.forEach(b => {
                        b.classList.remove('active', 'text-white', 'text-zinc-900');
                        b.classList.add('text-zinc-400');
                    });
                    this.classList.add('active', activeColor);
                    this.classList.remove('text-zinc-400');
                });
            });
        }

        // Register Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                        
                        // Update PWA badge
                        if (pwaBadgeElement) {
                            pwaBadgeElement.textContent = 'PWA Siap';
                            pwaBadgeElement.className = 'text-[8px] bg-emerald-500/10 text-emerald-500 px-2 py-1 rounded-lg border border-emerald-500/20 font-black';
                        }
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('New content available; please refresh.');
                                    toast('Update tersedia, refresh untuk mendapatkan versi terbaru');
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed:', err);
                        if (pwaBadgeElement) {
                            pwaBadgeElement.textContent = 'PWA Error';
                            pwaBadgeElement.className = 'text-[8px] bg-rose-500/10 text-rose-500 px-2 py-1 rounded-lg border border-rose-500/20 font-black';
                        }
                    });
            } else {
                if (pwaBadgeElement) {
                    pwaBadgeElement.textContent = 'No PWA';
                    pwaBadgeElement.className = 'text-[8px] bg-zinc-800 text-zinc-400 px-2 py-1 rounded-lg border border-white/5 font-black';
                }
            }
        }

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button in settings
            if (installBtn) {
                installBtn.classList.remove('hidden');
                installBtn.classList.add('animate-pulse-slow');
            }
            
            // Auto-show install prompt after 5 seconds on first visit
            if (!localStorage.getItem('pwa-install-shown')) {
                setTimeout(() => {
                    showInstallPrompt();
                    localStorage.setItem('pwa-install-shown', 'true');
                }, 5000);
            }
        });

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed successfully');
            deferredPrompt = null;
            if (installBtn) {
                installBtn.classList.add('hidden');
                installBtn.classList.remove('animate-pulse-slow');
            }
            closeModal('modal-install');
            toast('ðŸŽ‰ Aplikasi berhasil diinstall!');
            
            // Update UI
            updatePWAStatus();
        });

        // Function to show install prompt
        function showInstallPrompt() {
            if (deferredPrompt) {
                modalInstall.classList.add('active');
            } else {
                toast('â„¹ï¸ Aplikasi sudah terinstall atau tidak support');
            }
        }

        // Function to trigger installation
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted install');
                        toast('Menginstall aplikasi...');
                    } else {
                        console.log('User dismissed install');
                        toast('Install dibatalkan');
                    }
                    deferredPrompt = null;
                });
            } else {
                toast('Tidak dapat menginstall, coba refresh halaman');
            }
            closeModal('modal-install');
        }

        // Check if running as PWA
        function isRunningAsPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone ||
                   document.referrer.includes('android-app://');
        }

        // Update UI based on install status
        function updatePWAStatus() {
            const isPWA = isRunningAsPWA();
            
            if (appModeElement) {
                appModeElement.textContent = isPWA ? 'PWA Terinstall' : 'Browser';
                appModeElement.className = isPWA ? 'text-emerald-500 font-bold' : 'text-zinc-400';
            }
            
            if (isPWA) {
                console.log('Running as PWA');
                if (installBtn) {
                    installBtn.classList.add('hidden');
                    installBtn.classList.remove('animate-pulse-slow');
                }
                if (pwaBadgeElement) {
                    pwaBadgeElement.textContent = 'PWA Terinstall';
                    pwaBadgeElement.className = 'text-[8px] bg-emerald-500/10 text-emerald-500 px-2 py-1 rounded-lg border border-emerald-500/20 font-black';
                }
            }
        }

        // Function to check PWA features
        function checkPWAFeatures() {
            const features = {
                serviceWorker: 'serviceWorker' in navigator,
                installPrompt: 'beforeinstallprompt' in window,
                standalone: isRunningAsPWA(),
                notifications: 'Notification' in window,
                storage: 'localStorage' in window
            };
            console.log('PWA Features:', features);
        }

        function updateGreeting() {
            const h = new Date().getHours();
            let g = "Selamat Malam";
            if (h < 5) g = "Selamat Istirahat";
            else if (h < 11) g = "Selamat Pagi";
            else if (h < 15) g = "Selamat Siang";
            else if (h < 19) g = "Selamat Sore";
            
            document.getElementById('greeting').innerText = g;
        }

        async function handleLogin() {
            const e = document.getElementById('auth-email').value.trim();
            const p = document.getElementById('auth-password').value;
            
            if (!e || !p) {
                return toast("Email dan kata sandi harus diisi");
            }
            
            const loginBtn = document.querySelector('#screen-auth button');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = "Memproses...";
            loginBtn.disabled = true;
            
            try {
                const { data, error } = await sb.auth.signInWithPassword({ email: e, password: p });
                
                if (error) {
                    console.error('Login error:', error);
                    throw new Error("Email/Kata Sandi Salah");
                }
                
                user = data.user; 
                showApp();
                toast("Login berhasil! ðŸŽ‰");
                
            } catch (error) {
                toast(error.message || "Terjadi kesalahan");
            } finally {
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        }

        function showApp() {
            document.getElementById('screen-auth').classList.add('hidden');
            document.getElementById('screen-app').classList.remove('hidden');
            const username = user.email.split('@')[0];
            document.getElementById('user-display').innerText = username.charAt(0).toUpperCase() + username.slice(1);
            loadData();
        }

        async function loadData() {
            try {
                const { data: pData, error } = await sb.from('pockets').select('*').order('created_at');
                if (error) throw error;
                
                pockets = pData || [];
                
                // Update pocket count
                document.getElementById('pocket-count').textContent = `${pockets.length} Aktif`;
                
                const total = pockets.reduce((acc, p) => acc + Number(p.balance || 0), 0);
                document.getElementById('total-balance').innerText = formatIDR(total);
                
                const htmlSelect = pockets.map(p => `<option value="${p.id}">${p.name} (${formatIDR(p.balance)})</option>`).join('');
                const defaultOption = '<option value="">Pilih Brankas</option>';
                
                ['u-pocket', 'u-tf-from', 'u-tf-to'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.innerHTML = defaultOption + (htmlSelect || '');
                });

                renderHome();
                renderManage();
                loadHistory();
                
            } catch (error) {
                console.error('Error loading data:', error);
                toast("Error memuat data");
            }
        }

        function renderHome() {
            const s = document.getElementById('home-pockets-scroll');
            const isLight = document.documentElement.classList.contains('light-mode');
            
            if (pockets.length === 0) {
                s.innerHTML = `
                    <div class="jelly-card flex-none w-[180px] p-6 rounded-[2.5rem] flex flex-col items-center justify-center text-center">
                        <div class="w-10 h-10 rounded-2xl pocket-icon-bg flex items-center justify-center border pocket-icon-border mb-4">
                            <i data-lucide="wallet" class="w-5 h-5" style="color: var(--text-muted)"></i>
                        </div>
                        <p class="text-[9px] font-black uppercase" style="color: var(--text-muted)">Belum Ada Brankas</p>
                        <p class="text-[7px] mt-1" style="color: var(--text-muted)">Klik + untuk membuat</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            s.innerHTML = pockets.map(p => {
                const isTarget = p.target_amount > 0;
                const prog = isTarget ? Math.min(((p.balance||0)/p.target_amount)*100, 100) : 0;
                const progressColor = prog >= 100 ? 'bg-emerald-500' : (isLight ? 'bg-zinc-800' : 'bg-white');
                
                return `
                    <div class="jelly-card flex-none w-[180px] p-6 rounded-[2.5rem] flex flex-col justify-between snap-center relative overflow-hidden hover:scale-[1.02] transition-transform">
                        ${isTarget ? `
                            <div class="absolute top-4 right-4 text-[8px] font-black badge-item px-2 py-1 rounded-lg border backdrop-blur-sm">
                                ${Math.round(prog)}%
                            </div>
                        ` : ''}
                        
                        <div class="w-10 h-10 rounded-2xl pocket-icon-bg flex items-center justify-center border pocket-icon-border">
                            <i data-lucide="${p.emoji || 'wallet'}" class="w-5 h-5" style="color: var(--text-primary)"></i>
                        </div>
                        
                        <div class="mt-8">
                            <p class="text-[9px] font-black uppercase truncate" style="color: var(--text-muted)">${p.name}</p>
                            <p class="font-black text-sm truncate mt-0.5" style="color: var(--text-primary)">${formatIDR(p.balance)}</p>
                            
                            ${isTarget ? `
                                <div class="w-full h-1.5 progress-track rounded-full mt-3 overflow-hidden">
                                    <div class="h-full ${progressColor} transition-all duration-1000" style="width:${prog}%"></div>
                                </div>
                                <p class="text-[7px] mt-1 font-bold" style="color: var(--text-muted)">
                                    Target: ${formatIDR(p.target_amount)}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderManage() {
            const grid = document.getElementById('pockets-grid');
            const isLight = document.documentElement.classList.contains('light-mode');
            
            if (pockets.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-2 text-center py-10">
                        <div class="w-16 h-16 rounded-3xl pocket-icon-bg flex items-center justify-center border pocket-icon-border mx-auto mb-4">
                            <i data-lucide="wallet" class="w-8 h-8" style="color: var(--text-muted)"></i>
                        </div>
                        <p class="text-[10px] font-black uppercase" style="color: var(--text-muted)">Belum Ada Brankas</p>
                        <p class="text-[8px] mt-1" style="color: var(--text-muted)">Klik tombol + untuk membuat brankas pertama</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            grid.innerHTML = pockets.map(p => {
                const prog = p.target_amount > 0 ? Math.min(((p.balance||0)/p.target_amount)*100, 100) : 0;
                const balanceColor = prog >= 100 ? 'color: #10b981' : `color: var(--text-primary)`;
                
                return `
                <div onclick="openEditPocket('${p.id}')" class="jelly-card aspect-square p-6 rounded-[3rem] flex flex-col justify-between relative active:scale-95 transition-transform">
                    <div class="w-12 h-12 rounded-2xl pocket-icon-bg flex items-center justify-center border pocket-icon-border">
                        <i data-lucide="${p.emoji || 'wallet'}" class="w-6 h-6" style="color: var(--text-primary)"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-black uppercase truncate" style="color: var(--text-muted)">${p.name}</p>
                        <p class="font-black text-base mt-1" style="${balanceColor}">${formatIDR(p.balance)}</p>
                        ${p.target_amount > 0 ? `
                            <p class="text-[8px] font-bold text-emerald-500 mt-1 uppercase">
                                ${Math.round(prog)}% Tercapai
                            </p>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        async function loadHistory() {
            try {
                const { data, error } = await sb.from('transactions').select('*').order('created_at', {ascending: false}).limit(30);
                if (error) throw error;
                
                const items = data || [];
                const html = items.map(t => {
                    const date = new Date(t.created_at);
                    const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    const dateStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                    
                    let icon = 'minus';
                    let iconColor = 'text-rose-500';
                    let amountColor = 'color: var(--text-secondary)';
                    
                    if (t.type === 'income') {
                        icon = 'plus';
                        iconColor = 'text-emerald-500';
                        amountColor = 'color: #10b981';
                    } else if (t.type === 'transfer') {
                        icon = 'repeat';
                        iconColor = 'text-blue-500';
                        amountColor = 'color: #60a5fa';
                    }
                    
                    return `
                        <div onclick="openEditTransaction('${t.id}')" class="jelly-card flex items-center justify-between p-4 rounded-2xl group active:scale-[0.98] transition-all">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl history-icon-bg border pocket-icon-border flex items-center justify-center ${iconColor}">
                                    <i data-lucide="${icon}" class="w-4 h-4"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-xs truncate w-32" style="color: var(--text-primary)">${t.note || (t.type === 'transfer' ? 'Transfer Saldo' : t.type === 'income' ? 'Pemasukan' : 'Pengeluaran')}</p>
                                    <p class="text-[8px] font-black uppercase tracking-tighter" style="color: var(--text-muted)">
                                        ${dateStr} â€¢ ${timeStr}
                                    </p>
                                </div>
                            </div>
                            <p class="font-black text-xs" style="${amountColor}">
                                ${t.type === 'income' ? '+' : t.type === 'expense' ? '-' : 'â†”'} ${formatIDR(t.amount)}
                            </p>
                        </div>
                    `;
                }).join('');
                
                const empty = `
                    <div class="text-center py-10">
                        <div class="w-16 h-16 rounded-3xl pocket-icon-bg flex items-center justify-center border pocket-icon-border mx-auto mb-4">
                            <i data-lucide="file-text" class="w-8 h-8" style="color: var(--text-muted)"></i>
                        </div>
                        <p class="text-[10px] font-black uppercase tracking-[0.3em]" style="color: var(--text-muted)">Belum Ada Transaksi</p>
                        <p class="text-[8px] mt-1" style="color: var(--text-muted)">Mulai catat transaksi pertama Anda</p>
                    </div>
                `;
                
                document.getElementById('home-history').innerHTML = html || empty;
                document.getElementById('full-history').innerHTML = html || empty;
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading history:', error);
                toast("Error memuat riwayat");
            }
        }

        function setupInfiniteScroll() {
            let loading = false;
            
            window.addEventListener('scroll', () => {
                const activeView = document.querySelector('.page-view.active').id;
                if ((activeView === 'view-pockets' || activeView === 'view-history') && !loading) {
                    const scrollTop = window.scrollY || document.documentElement.scrollTop;
                    const scrollHeight = document.documentElement.scrollHeight;
                    const clientHeight = window.innerHeight;
                    
                    if (scrollTop + clientHeight >= scrollHeight - 100) {
                        loading = true;
                        const loaderId = activeView === 'view-pockets' ? 'loader-pockets' : 'loader-history';
                        const loader = document.getElementById(loaderId);
                        
                        if (loader) {
                            loader.classList.remove('hidden');
                            // Simulate loading more data
                            setTimeout(() => {
                                loader.classList.add('hidden');
                                loading = false;
                                toast("Memuat data tambahan...");
                            }, 1500);
                        }
                    }
                }
            });
        }

        async function openEditTransaction(id) {
            try {
                editingTxId = id;
                const { data: t, error } = await sb.from('transactions').select('*').eq('id', id).single();
                if (error) throw error;
                if(!t) return;
                
                document.getElementById('tx-title').innerText = "Edit Record";
                document.getElementById('u-amount').value = t.amount.toLocaleString('id-ID');
                document.getElementById('u-note').value = t.note || '';
                document.getElementById('btn-del-tx').classList.remove('hidden');
                
                // Hide mode selector on edit for data integrity
                document.getElementById('tx-mode-selector').classList.add('hidden');
                
                if(t.type === 'transfer') {
                    setMode('transfer', null);
                    document.getElementById('u-tf-from').value = t.from_pocket_id;
                    document.getElementById('u-tf-to').value = t.to_pocket_id;
                } else {
                    setMode(t.type, null);
                    document.getElementById('u-pocket').value = (t.type === 'income' ? t.to_pocket_id : t.from_pocket_id);
                }
                
                document.getElementById('modal-unified').classList.add('active');
                setTimeout(() => document.getElementById('u-amount').focus(), 100);
                
            } catch (error) {
                console.error('Error opening transaction:', error);
                toast("Error membuka transaksi");
            }
        }

        async function saveUnified() {
            // Parse formatted number
            const amount = parseFormattedNumber(document.getElementById('u-amount').value);
            const note = document.getElementById('u-note').value.trim();
            
            if (!amount || amount <= 0) return toast("Nominal tidak valid!");
            
            // Validate based on mode
            if (currentMode === 'transfer') {
                const fromId = document.getElementById('u-tf-from').value;
                const toId = document.getElementById('u-tf-to').value;
                if (!fromId || !toId) return toast("Pilih brankas sumber & tujuan!");
                if (fromId === toId) return toast("Brankas sumber dan tujuan tidak boleh sama!");
            } else {
                const pId = document.getElementById('u-pocket').value;
                if (!pId) return toast("Pilih brankas terlebih dahulu!");
            }

            try {
                if(editingTxId) {
                    // Update basic info
                    await sb.from('transactions').update({ note, amount }).eq('id', editingTxId);
                    toast("Transaksi diperbarui");
                } else {
                    if (currentMode === 'transfer') {
                        const fromId = document.getElementById('u-tf-from').value;
                        const toId = document.getElementById('u-tf-to').value;
                        
                        // Check if source pocket has enough balance
                        const pF = pockets.find(x => x.id == fromId);
                        if (!pF || Number(pF.balance) < amount) {
                            return toast("Saldo brankas sumber tidak cukup!");
                        }
                        
                        await sb.from('transactions').insert([{ 
                            user_id: user.id, 
                            amount, 
                            type: 'transfer', 
                            note: note || 'Transfer Antar Brankas', 
                            from_pocket_id: fromId, 
                            to_pocket_id: toId 
                        }]);
                        
                        const pT = pockets.find(x => x.id == toId);
                        await sb.from('pockets').update({ balance: Number(pF.balance) - amount }).eq('id', fromId);
                        await sb.from('pockets').update({ balance: Number(pT.balance) + amount }).eq('id', toId);
                        
                        toast("Transfer berhasil");
                    } else {
                        const pId = document.getElementById('u-pocket').value;
                        const p = pockets.find(x => x.id == pId);
                        
                        // Check if expense is possible
                        if (currentMode === 'expense' && Number(p.balance) < amount) {
                            return toast("Saldo brankas tidak cukup!");
                        }
                        
                        await sb.from('transactions').insert([{ 
                            user_id: user.id, 
                            amount, 
                            type: currentMode, 
                            note: note || (currentMode === 'income' ? 'Pemasukan' : 'Pengeluaran'), 
                            from_pocket_id: currentMode === 'expense' ? pId : null, 
                            to_pocket_id: currentMode === 'income' ? pId : null 
                        }]);
                        
                        const nb = currentMode === 'income' ? (Number(p.balance) + amount) : (Number(p.balance) - amount);
                        await sb.from('pockets').update({ balance: nb }).eq('id', pId);
                        
                        toast(currentMode === 'income' ? "Pemasukan dicatat" : "Pengeluaran dicatat");
                    }
                }
                
                closeModal('modal-unified'); 
                loadData();
                
            } catch (error) {
                console.error('Error saving transaction:', error);
                toast("Error menyimpan transaksi");
            }
        }

        async function deleteTransaction() {
            if(!confirm("Hapus transaksi ini? Saldo akan dikembalikan.")) return;
            
            try {
                const { data: t, error } = await sb.from('transactions').select('*').eq('id', editingTxId).single();
                if (error) throw error;
                
                // Revert balance changes
                if(t.type === 'income') {
                    const p = pockets.find(x => x.id == t.to_pocket_id);
                    if(p) await sb.from('pockets').update({ balance: Number(p.balance) - t.amount }).eq('id', t.to_pocket_id);
                } else if(t.type === 'expense') {
                    const p = pockets.find(x => x.id == t.from_pocket_id);
                    if(p) await sb.from('pockets').update({ balance: Number(p.balance) + t.amount }).eq('id', t.from_pocket_id);
                } else if(t.type === 'transfer') {
                    const pF = pockets.find(x => x.id == t.from_pocket_id);
                    const pT = pockets.find(x => x.id == t.to_pocket_id);
                    if(pF) await sb.from('pockets').update({ balance: Number(pF.balance) + t.amount }).eq('id', t.from_pocket_id);
                    if(pT) await sb.from('pockets').update({ balance: Number(pT.balance) - t.amount }).eq('id', t.to_pocket_id);
                }
                
                await sb.from('transactions').delete().eq('id', editingTxId);
                closeModal('modal-unified'); 
                loadData(); 
                toast("Transaksi dihapus");
                
            } catch (error) {
                console.error('Error deleting transaction:', error);
                toast("Error menghapus transaksi");
            }
        }

        async function savePocket() {
            const name = document.getElementById('p-name').value.trim();
            const bal = parseFormattedNumber(document.getElementById('p-balance').value);
            const target = parseFormattedNumber(document.getElementById('p-target').value);
            
            if(!name) return toast("Nama brankas wajib diisi!");
            if(bal < 0) return toast("Saldo tidak boleh negatif!");
            if(target < 0) return toast("Target tidak boleh negatif!");
            
            try {
                const payload = { 
                    user_id: user.id, 
                    name, 
                    balance: bal, 
                    emoji: selectedIcon, 
                    target_amount: target 
                };
                
                if(editingPocketId) {
                    await sb.from('pockets').update(payload).eq('id', editingPocketId);
                    toast("Brankas diperbarui");
                } else {
                    await sb.from('pockets').insert([payload]);
                    toast("Brankas dibuat");
                }
                
                closeModal('modal-pocket'); 
                loadData();
                
            } catch (error) {
                console.error('Error saving pocket:', error);
                toast("Error menyimpan brankas");
            }
        }

        async function deletePocket() {
            if(!confirm("Hapus brankas ini? Semua transaksi terkait juga akan dihapus.")) return;
            
            try {
                await sb.from('transactions')
                    .delete()
                    .or(`from_pocket_id.eq.${editingPocketId},to_pocket_id.eq.${editingPocketId}`);
                
                await sb.from('pockets').delete().eq('id', editingPocketId);
                
                closeModal('modal-pocket'); 
                loadData();
                toast("Brankas dihapus");
                
            } catch (error) {
                console.error('Error deleting pocket:', error);
                toast("Error menghapus brankas");
            }
        }

        function nav(id, btn) {
            // Update page views
            document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            const isLight = document.documentElement.classList.contains('light-mode');
            const activeColor = isLight ? 'text-zinc-900' : 'text-white';
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active', 'text-white', 'text-zinc-900');
                b.classList.add('text-zinc-400');
            });
            
            if (btn) {
                btn.classList.add('active', activeColor);
                btn.classList.remove('text-zinc-400');
                btn.classList.add('animate-jelly');
                setTimeout(() => btn.classList.remove('animate-jelly'), 600);
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Refresh icons
            lucide.createIcons();
        }

        function setMode(m, btn) {
            currentMode = m;
            
            // Update button styles
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('bg-white', 'text-black', 'text-zinc-400');
                b.classList.add('text-zinc-400');
            });
            
            if(btn) {
                btn.classList.remove('text-zinc-400');
                btn.classList.add('bg-white', 'text-black');
            } else {
                // If no button provided (edit mode), highlight the correct one
                const modeBtns = document.querySelectorAll('.mode-btn');
                modeBtns.forEach(b => {
                    if (b.textContent.toLowerCase().includes(m)) {
                        b.classList.remove('text-zinc-400');
                        b.classList.add('bg-white', 'text-black');
                    }
                });
            }
            
            // Toggle UI elements
            document.getElementById('ui-standard').classList.toggle('hidden', m === 'transfer');
            document.getElementById('ui-transfer').classList.toggle('hidden', m !== 'transfer');
        }

        function renderIconPicker() {
            const container = document.getElementById('pocket-icons');
            container.innerHTML = ICONS.map(i => `
                <button onclick="selectIcon('${i}', this)" 
                        class="icon-btn p-3 rounded-2xl bg-zinc-900 border border-transparent hover:border-white/10 hover:bg-zinc-800 transition-all">
                    <i data-lucide="${i}" class="w-4 h-4 text-zinc-500"></i>
                </button>
            `).join('');
            lucide.createIcons();
            
            // Select first icon by default
            if (ICONS.length > 0) {
                const firstIconBtn = container.querySelector('.icon-btn');
                if (firstIconBtn) {
                    selectIcon(ICONS[0], firstIconBtn);
                }
            }
        }

        function selectIcon(i, b) {
            selectedIcon = i;
            const isLight = document.documentElement.classList.contains('light-mode');
            const activeBorder = isLight ? 'border-zinc-800' : 'border-white';
            const activeBg = isLight ? 'bg-zinc-800/10' : 'bg-white/10';
            const activeTextColor = isLight ? 'text-zinc-800' : 'text-white';
            
            document.querySelectorAll('.icon-btn').forEach(btn => {
                btn.classList.remove('border-white', 'bg-white/10', 'border-zinc-800', 'bg-zinc-800/10');
                btn.querySelector('i').classList.remove('text-white', 'text-zinc-800');
                btn.querySelector('i').classList.add('text-zinc-500');
            });
            
            if(b) {
                b.classList.add(activeBorder, activeBg);
                b.querySelector('i').classList.remove('text-zinc-500');
                b.querySelector('i').classList.add(activeTextColor);
            }
        }

        function openUnifiedModal() { 
            editingTxId = null;
            document.getElementById('tx-title').innerText = "Catatan Baru";
            document.getElementById('u-amount').value = ''; 
            document.getElementById('u-note').value = '';
            document.getElementById('btn-del-tx').classList.add('hidden');
            document.getElementById('tx-mode-selector').classList.remove('hidden');
            
            // Reset to expense mode
            const firstModeBtn = document.querySelector('.mode-btn');
            if (firstModeBtn) {
                setMode('expense', firstModeBtn);
            }
            
            document.getElementById('modal-unified').classList.add('active'); 
            setTimeout(() => document.getElementById('u-amount').focus(), 100);
        }

        function openEditPocket(id) {
            editingPocketId = id; 
            const p = pockets.find(x => x.id == id);
            
            if (!p) {
                toast("Brankas tidak ditemukan");
                return;
            }
            
            document.getElementById('p-name').value = p.name; 
            document.getElementById('p-balance').value = p.balance.toLocaleString('id-ID');
            document.getElementById('p-target').value = (p.target_amount || '').toLocaleString('id-ID');
            document.getElementById('btn-del-p').classList.remove('hidden');
            document.getElementById('modal-pocket').classList.add('active');
            
            // Select the correct icon
            selectIcon(p.emoji || 'wallet', null);
            
            // Find and highlight the icon button
            const isLight = document.documentElement.classList.contains('light-mode');
            const activeBorder = isLight ? 'border-zinc-800' : 'border-white';
            const activeBg = isLight ? 'bg-zinc-800/10' : 'bg-white/10';
            const activeTextColor = isLight ? 'text-zinc-800' : 'text-white';
            
            const iconButtons = document.querySelectorAll('.icon-btn');
            iconButtons.forEach(btn => {
                const iconName = btn.querySelector('i').getAttribute('data-lucide');
                if (iconName === (p.emoji || 'wallet')) {
                    btn.classList.add(activeBorder, activeBg);
                    btn.querySelector('i').classList.remove('text-zinc-500');
                    btn.querySelector('i').classList.add(activeTextColor);
                }
            });
        }

        function openPocketModal() {
            editingPocketId = null; 
            document.getElementById('p-name').value = ''; 
            document.getElementById('p-balance').value = ''; 
            document.getElementById('p-target').value = '';
            document.getElementById('btn-del-p').classList.add('hidden');
            document.getElementById('modal-pocket').classList.add('active');
            
            // Reset icon selection to first icon
            const firstIconBtn = document.querySelector('.icon-btn');
            if (firstIconBtn) {
                selectIcon(ICONS[0], firstIconBtn);
            }
        }

        function closeModal(id) { 
            document.getElementById(id).classList.remove('active'); 
        }
        
        function formatIDR(n) { 
            return new Intl.NumberFormat('id-ID', { 
                style: 'currency', 
                currency: 'IDR', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(n); 
        }
        
        function toast(m) { 
            const t = document.getElementById('toast'); 
            t.innerText = m; 
            t.style.opacity = '1'; 
            t.style.transform = 'translate(-50%, 0)';
            
            setTimeout(() => { 
                t.style.opacity = '0';
                t.style.transform = 'translate(-50%, -10px)';
            }, 3000); 
        }
        
        function logout() { 
            if(confirm("Keluar dari akun?")) {
                sb.auth.signOut().then(() => {
                    toast("Logout berhasil");
                    setTimeout(() => window.location.reload(), 1000);
                });
            }
        }
        
        async function resetAllData() { 
            if(!confirm("Hapus permanen SEMUA data? Tindakan ini tidak dapat dibatalkan!")) return;
            
            try {
                await sb.from('transactions').delete().eq('user_id', user.id); 
                await sb.from('pockets').delete().eq('user_id', user.id); 
                
                loadData(); 
                toast("Semua data dihapus");
            } catch (error) {
                console.error('Error resetting data:', error);
                toast("Error menghapus data");
            }
        }
        
        async function downloadCSV() {
            try {
                const { data, error } = await sb.from('transactions').select('*');
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    return toast("Tidak ada data untuk diekspor");
                }
                
                const headers = ["Tanggal", "Waktu", "Catatan", "Tipe", "Jumlah", "Dari Brankas", "Ke Brankas"];
                const rows = data.map(t => {
                    const date = new Date(t.created_at);
                    const pocketFrom = pockets.find(p => p.id === t.from_pocket_id);
                    const pocketTo = pockets.find(p => p.id === t.to_pocket_id);
                    
                    return [
                        date.toLocaleDateString('id-ID'),
                        date.toLocaleTimeString('id-ID'),
                        `"${t.note || ''}"`,
                        t.type === 'income' ? 'Pemasukan' : t.type === 'expense' ? 'Pengeluaran' : 'Transfer',
                        t.amount,
                        pocketFrom ? pocketFrom.name : '',
                        pocketTo ? pocketTo.name : ''
                    ].join(',');
                });
                
                const csv = [headers.join(','), ...rows].join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `Laporan_Keuangan_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                toast("Laporan berhasil diunduh");
            } catch (error) {
                console.error('Error downloading CSV:', error);
                toast("Error mengunduh laporan");
            }
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + N for new transaction
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                openUnifiedModal();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                const activeModals = document.querySelectorAll('.modal-base.active');
                if (activeModals.length > 0) {
                    activeModals.forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            }
        });

        window.onload = init;
    </script>
</body>
</html>
